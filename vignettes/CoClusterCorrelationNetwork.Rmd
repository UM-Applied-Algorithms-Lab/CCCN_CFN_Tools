---
title: "Filtered CoCluster Correlation Network Creation Guide"
author: "Nagashree A, McKayl Bailey, Grant Smith, Madison Moffett"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    theme: cosmo
    highlight: tango
vignette:
  VignetteIndexEntry: "Mass_Spec_Data_Processing"
  VignetteEngine: "knitr::rmarkdown"
  VignetteEncoding: "UTF-8"
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "plots/",
  fig.width = 8,
  fig.height = 6,
  out.width = "100%",
  results = "hold"
)
```

# This Package  
The CCCN_CFN package takes experimental data of post-translational modifications based on experimental conditions and generates clusters of likely pathways. These pathways are generated based on analysis of which ptms cluster together (in their ptms based on the same environmental conditions) compared to how those proteins are known to interact (using the STRINGdb database).

**An important note about this package:** there are no returned outputs from any of the functions. All outputs listed are assigned to the Global Namespace in order to prevent loss of data and promote ease of use. Some functions also pull variables from the global namespace. Ensure that all data is loaded into the global environment especially if analysis is completed across multiple sessions.  

# This File  
This vignette is intended to be a step-by-step guide to walk users through the process of using the CCCN_CFN package. It includes an example pipeline demonstrating how to run the full analysis along with descriptions of each function. this pipeline must be run in order as subsequent steps require the data produced in previous steps. Estimated run-times are included with each description and are based on a preliminary dataset of \~9,000 post-translational modifications and 70 experimental conditions processed with a 12th Gen i5 processor and 8GB of RAM.  

# Pipeline  

## Step 1: Make Cluster List  

#### Code  

```{r eval = FALSE}
MakeClusterList(ptmtable, toolong = 3.5)
```

#### Outputs  

![](vig_figs/EU_MCL.png)  
**Figure 1** Example plot produced by MakeClusterList calculated using Euclidean Distance  
  
![](vig_figs/MCL-output.png)  
**Figure 2** Output of MakeClusterList  

```{r echo = FALSE, eval = TRUE}
load('vig_figs/eu-clusters.rda')
head(eu_ptms_list, 1)
```
**Figure 3** First cluster created by Euclidean Distance  

#### Description  

Make Cluster list is the first step in the analyzing one's data. This function takes the post-translational modification table and runs it through three calculations of distance: Euclidean Distance, Spearman Dissimilarity (1 - |Spearman Correlation|), and the average of the two of these. These calculations find the 'distance' between ptms based upon under what conditions they occur. These matricies are then run through Tsne in order to put them into a 3-dimensional space. Please note: Tsne involves an element of randomness; in order to get the same results, set.seed(#) must be called. A correlation table is also produced based on the Spearman Correlation table.  

#### Input  
- ptmtable
  - A data frame with rows of ptms and columns of experimental conditions  
- toolong
  - Defaults to 3.5; threshold for cluster separation  

#### Output  
- ptm.correlation.matrix
  - A data frame showing the correlation between ptms (as the rows and the columns). NAs are placed along the diagonal  
- eu_ptms_list
  - A three-dimensional data frame used to represent ptms in space to show relationships between them based on distances. Based on Euclidean Distance  
- sp_ptms_list
  - A three-dimensional data frame used to represent ptms in space to show relationships between them based on distances. Based on Spearman Dissimilarity  
- sed_ptms_list 
  - A three-dimensional data frame used to represent ptms in space to show relationships between them based on distances. Based on the average between Euclidean Distance and Spearman Dissimilarity. 

#### Estimated run-time  
1hr 30mins

## Step 2: Make Correlation Network  

#### Code  

```{r eval = FALSE}
MakeCorrelationNetwork(keeplength = 2)
```

#### Outputs  

![](vig_figs/cccn_matrix.png)  
**Figure 4** First 17 rows and columns of the cccn_matrix produced by MakeCorrelationNetwork  

#### Description  

Make Correlation Network first finds the intersection between the Euclidian, Spearman, and SED Tsne matrices in order to find the intersection between the three groups. It then adds the Genes in these PTMs to a list of common clusters and turns it into an adjacency matrix. This adjacency matrix is used to filter relevant data--clusters--from the Spearman correlation matrix. The resultant cccn_matrix showing strength of relationships between proteins using the common clusters between the three distance metrics is returned a matrix.  

#### Input  
- keeplength  
  - Defaults to 2; MakeClusterList only saves subsets whose size is strictly *greater* than keeplength. (I.e. ['AARS', 'ABR'] will be discarded unless keeplength < 2)  
- From Global Namespace:  
  - Should **not** but listed in function call, but user must ensure that it is in the gloal environment  
  - ptm.correlation.matrix  
    - A data frame showing the correlation between ptms (as the rows and the columns). NAs are placed along the diagonal. 
  - eu_ptms_list  
    - A three-dimensional data frame used to represent ptms in space to show relationships between them based on distances. Based on Euclidean Distance  
  - sp_ptms_list  
    - A three-dimensional data frame used to represent ptms in space to show relationships between them based on distances. Based on Spearman Dissimilarity  
  - sed_ptms_list  
    - A three-dimensional data frame used to represent ptms in space to show relationships between them based on distances. Based on the average between Euclidean Distance and Spearman Dissimilarity  

#### Output  
- cccn_matrix  
  - A matrix showing strength of relationships between proteins using common clusters between the three distance metrics  

#### Estimated run-time  
2hrs 30mins  

## Optional Pre-Step 3: Retrieve Alternate Edgefiles

#### Code  

```{r eval = FALSE}
make_db_input(cccn_matrix)
```

#### Output  

![](vig_figs/db_nodes-txt.png) 
**Figure 5** First 15 lines from the produced text file 

#### Description  

**NOTE:** This step is optional but provides more information for filtering data.  

This step requires more effort from the user than any other step but the package still attempts to simplify this process. First, the user runs make_db_input in order to produce a text file that has all of the gene names separated by new lines. This information can then be put into the user's choice of databases to find more interactions. Suggested databases include GeneMANIA and Pathway Commons Network--both of which can be installed on the Cytoscape App.

#### Input   
- cccn_matrix  
  - A matrix showing strength of relationships between proteins using the common clusters between the three distance metrics  

#### Output  
- db_nodes.txt
  - A text file with the names of all of the genes   
  - Saved into the user's working directory  

#### Estimated run-time  
1s (to get text file)

## Step 3: Find PPI Edges 

#### Code  

```{r eval = FALSE}
find_ppi_edges(cccn_matrix, db_file_paths = c())
```

#### Outputs  

![](vig_figs/ppi_network.png)  
**Figure 6** First 19 rows of the ppi_network produced by find_ppi_edges  

#### Description  

**Note:** Examples take about 5-10 minutes to run.

Protein-Protein Interaction (or PPI) networks are networks that show us how different proteins are known interact with each other. STRINGdb--a database of these PPI networks--is automatically consulted along with any other database files that are generated and entered by the user. It then gathers data from the PPI networks and filters them down to only examine the determined genes of interest. The data from STRINGdb and any provided files are then combined and returned. The returned data frame shows how strongly the proteins are known to interact.

#### Input  

- cccn_matrix  
  - A matrix showing strength of relationships between proteins using the common clusters between the three distance metrics  
- db_file_paths (optional)  
  - A vector of paths to the additional ppi network files. This is initialized to an empty vector  

#### Output  
- ppi_network  
  - A dataframe representing how strongly proteins are known to interact  

#### Estimated run-time  
20mins (only using STRINGdb)

## Step 4: Cluster Filtered Network  

#### Code  

```{r eval = FALSE}
ClusterFilteredNetwork(accuracy)
```

#### Outputs  

![](vig_figs/cfn.png)  
**Figure 7** First 19 rows of the cfn_network produced by ClusterfilteredNetwork  

#### Description  

**Note:** This function, like the ones before it, will pull required data from the global environment. 
Requires both a cccn_matrix and a list of PPI edges. Checks all PPI edges to see if their edge weight is equal (or under the bounds of the accuracy parameter) to the weight of the same edge in the matrix. If it is not, then it will be removed from the list of PPI edges.  

#### Input  
- accuracy  
   - The maximum difference allowed for a PPI edge to still be "equal" to the cccn value  
- From Global Namespace:  
  - Should **not** but listed in function call, but user must ensure that it is in the gloal environment  
  - cccn_matrix  
    - A matrix showing strength of relationships between proteins using the common clusters between the three distance metrics  
  - ppi_network  
    - A dataframe representing how strongly proteins are known to interact  

#### Output  
- cfn_network  
  - A version of ppi_network with only the edges that exist in cccn_matrix  
  - Note that the STRINGdb.combined_score is on a scale of 0-1000 while cor_weight is on a scale of 0-1

#### Estimated run-time  
10mins



















